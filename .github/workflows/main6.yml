name: Triggered-Intervalss-Job

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  execute:
    runs-on: ${{ matrix.os }}
    env:
      PY_COLORS: "1"

    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.13"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Brave Browser
        shell: bash
        run: |
          echo "Installing Brave browser..."
          sudo apt-get update -y
          sudo apt-get install -y apt-transport-https curl
          curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg \
            https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] \
            https://brave-browser-apt-release.s3.brave.com/ stable main" \
            | sudo tee /etc/apt/sources.list.d/brave-browser-release.list
          sudo apt-get update
          sudo apt-get install -y brave-browser

      - name: Install Cloudflare WARP client
        shell: bash
        run: |
          echo "Initializing WARP installation..."
          sudo apt-get update -y
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg \
            | sudo gpg --yes --dearmor \
            -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] \
            https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/cloudflare-client.list

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends cloudflare-warp

          sudo warp-cli --accept-tos registration new
          sudo warp-cli --accept-tos mode warp+doh
          sudo warp-cli --accept-tos connect
          sleep 6

      - name: Validate WARP connection
        shell: bash
        run: |
          echo "Verifying WARP status..."
          curl -s https://www.cloudflare.com/cdn-cgi/trace | grep "warp=on"

      - name: Configure system locale
        run: |
          sudo apt-get install -y tzdata locales
          sudo locale-gen en_US.UTF-8
          sudo localectl set-locale LANG=en_US.UTF-8
          export LANG=en_US.UTF-8
          sudo update-locale

          locale -a
          locale
          locale -c -k LC_NUMERIC
          localectl status

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade wheel
          pip install --upgrade seleniumbase
          pip install --upgrade pyautogui
          pip install --upgrade pymongo
          pip install --upgrade python-xlib

      - name: Install ChromeDriver via SeleniumBase
        run: |
          seleniumbase install chromedriver

      - name: Execute automation script
        run: |
          python peni.py --brave --incognito --do-not-track --xvfb --screenshot

      - name: Archive screenshots
        uses: actions/upload-artifact@v4
        with:
          name: sb-screenshots
          path: ./latest_logs/
